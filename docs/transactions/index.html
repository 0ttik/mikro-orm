<!DOCTYPE html>
<html lang="en" data-theme="">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135618258-1"></script>
<script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
              gtag('config', 'UA-135618258-1');</script>
<script type="text/javascript">/*<![CDATA[*/window.__chunkMapping={"17896441":["/17896441.603aee67.js"],"32668750":["/32668750.953c0cb6.js"],"71613181":["/71613181.6f75aef5.js"],"main":["/main.4967bba5.js"],"0165f141":["/0165f141.ac0e3d38.js"],"01a85c17":["/01a85c17.bb155a6e.js"],"03ae3cc8":["/03ae3cc8.6166ff35.js"],"04194b7e":["/04194b7e.40f83cc2.js"],"0817e596":["/0817e596.7f639533.js"],"090a48c7":["/090a48c7.6ae645e7.js"],"0bc2fab3":["/0bc2fab3.c286caac.js"],"11e461fb":["/11e461fb.510ce43c.js"],"13d89a72":["/13d89a72.eba1b004.js"],"155e4ec1":["/155e4ec1.6bb8bf45.js"],"18faba32":["/18faba32.b82242d3.js"],"1a786bf4":["/1a786bf4.815afb52.js"],"1a9639fa":["/1a9639fa.2bdee227.js"],"1b968538":["/1b968538.b0265c08.js"],"1be78505":["/1be78505.98bf3285.js"],"1c47a88c":["/1c47a88c.09e0c2d5.js"],"1d3f31ec":["/1d3f31ec.8fa85738.js"],"22dedd20":["/22dedd20.d08ae2c0.js"],"24a88974":["/24a88974.620e76ca.js"],"253bcb73":["/253bcb73.b89d731b.js"],"25413a3b":["/25413a3b.c5e04409.js"],"2820f490":["/2820f490.73141414.js"],"29b182ff":["/29b182ff.f990cf9b.js"],"2bccb399":["/2bccb399.261ecb45.js"],"2ceb80fd":["/2ceb80fd.b2249882.js"],"2ecdc8fb":["/2ecdc8fb.b7f7adb9.js"],"316247d4":["/316247d4.c28a913e.js"],"339fb5e5":["/339fb5e5.e8940281.js"],"36bc294d":["/36bc294d.b48548f6.js"],"393cfc3b":["/393cfc3b.99bbcc8d.js"],"3a30784c":["/3a30784c.e2d65ddc.js"],"3b8c55ea":["/3b8c55ea.4ac40da1.js"],"3b8cdd41":["/3b8cdd41.fe5a3169.js"],"3bfe7631":["/3bfe7631.6de5da54.js"],"3ece10bb":["/3ece10bb.07823c41.js"],"41baae90":["/41baae90.f0d8fc06.js"],"44e48195":["/44e48195.bd1600d9.js"],"460227ed":["/460227ed.1ab5e156.js"],"4919cc6e":["/4919cc6e.40eb67cb.js"],"4a559537":["/4a559537.d5a9b486.js"],"4e505a26":["/4e505a26.0a5c6c39.js"],"4e719ec1":["/4e719ec1.23d8e9d7.js"],"4f47f666":["/4f47f666.db3103d3.js"],"4fe60abc":["/4fe60abc.3c7b0a5b.js"],"5024052a":["/5024052a.56629949.js"],"5196fa5b":["/5196fa5b.e99d5c82.js"],"51d00ed2":["/51d00ed2.56141f77.js"],"523e262a":["/523e262a.65836e6d.js"],"563cfae8":["/563cfae8.3d215dfb.js"],"58a396d4":["/58a396d4.2af60658.js"],"58d916aa":["/58d916aa.cb96e6ec.js"],"590acbb4":["/590acbb4.86882ddd.js"],"596abfae":["/596abfae.ed07ff42.js"],"5ac07ed9":["/5ac07ed9.e2d5c979.js"],"5e41dd96":["/5e41dd96.8ceeeb08.js"],"610c5417":["/610c5417.12a2ca75.js"],"62399e57":["/62399e57.bc72c331.js"],"64281fc4":["/64281fc4.7918ec56.js"],"6448a36b":["/6448a36b.71508bd2.js"],"6875c492":["/6875c492.cadadcfc.js"],"69c1abea":["/69c1abea.01088960.js"],"69d76d20":["/69d76d20.30e64530.js"],"6a4406c5":["/6a4406c5.b8bc6867.js"],"704e4a47":["/704e4a47.7b682b5a.js"],"70ff3d70":["/70ff3d70.7b9179e7.js"],"71c17fcd":["/71c17fcd.87f2cb79.js"],"72d0b912":["/72d0b912.bfd53100.js"],"7494a489":["/7494a489.896fc87b.js"],"78925a07":["/78925a07.de38204b.js"],"7911db54":["/7911db54.3793bf5e.js"],"79b08830":["/79b08830.44fe871e.js"],"79c1ba4c":["/79c1ba4c.b4b47f87.js"],"7b9a3e1d":["/7b9a3e1d.f810c536.js"],"7c54a221":["/7c54a221.65897242.js"],"7c6e199f":["/7c6e199f.fa9a57e5.js"],"7d1d7b10":["/7d1d7b10.a8c7912b.js"],"815a1b88":["/815a1b88.5f290132.js"],"8324c471":["/8324c471.61f7000c.js"],"83737d0e":["/83737d0e.62d3c053.js"],"8393d317":["/8393d317.f82948ab.js"],"85dcc9d1":["/85dcc9d1.1936ae69.js"],"88bdbb58":["/88bdbb58.4f39cfa6.js"],"89cfa98a":["/89cfa98a.ce1edf93.js"],"8aab36f3":["/8aab36f3.04a93f6e.js"],"8f1dd480":["/8f1dd480.3bd30f2c.js"],"926a0f04":["/926a0f04.4476b332.js"],"92bebd58":["/92bebd58.99d29ad5.js"],"967e8efc":["/967e8efc.066d61ab.js"],"96e82939":["/96e82939.bbefd458.js"],"9aa60ca8":["/9aa60ca8.261cd2d6.js"],"9aaad8fa":["/9aaad8fa.0efea9bb.js"],"9aecfe90":["/9aecfe90.58895cce.js"],"9b1f06f1":["/9b1f06f1.1f7c65e4.js"],"9ba33c8a":["/9ba33c8a.2e7c54d7.js"],"9c9e4252":["/9c9e4252.1e481b0c.js"],"9ed00105":["/9ed00105.4c243e1d.js"],"a00a1f30":["/a00a1f30.039db462.js"],"a0f8a6c2":["/a0f8a6c2.581e0e3d.js"],"a1217a2d":["/a1217a2d.72b5934f.js"],"a1dbe7e3":["/a1dbe7e3.718fa8d2.js"],"a1ef3573":["/a1ef3573.da38e1ab.js"],"a26a8898":["/a26a8898.27affb50.js"],"a3713279":["/a3713279.844a73a8.js"],"a3ad7abc":["/a3ad7abc.cf521554.js"],"a6aa9e1f":["/a6aa9e1f.190df153.js"],"ac449b47":["/ac449b47.09d2fb7a.js"],"ae87428a":["/ae87428a.43ea3adf.js"],"aff78db2":["/aff78db2.a49c4b0d.js"],"b3b1166c":["/b3b1166c.a42145e7.js"],"b66c1ead":["/b66c1ead.499e38bd.js"],"b6943453":["/b6943453.22f2227d.js"],"b6fabc31":["/b6fabc31.59e5103a.js"],"ba6c5c63":["/ba6c5c63.cb091361.js"],"ba9fc493":["/ba9fc493.efc12d58.js"],"bc6b6808":["/bc6b6808.c36ba359.js"],"be6bb72c":["/be6bb72c.cca3cdb5.js"],"c0336054":["/c0336054.6484f268.js"],"c377a04b":["/c377a04b.d4a44e9a.js"],"c3f2c997":["/c3f2c997.31401824.js"],"c478db7c":["/c478db7c.e797284d.js"],"c4f5d8e4":["/c4f5d8e4.c147d033.js"],"c7285cdf":["/c7285cdf.0029d46b.js"],"c7c6bbb0":["/c7c6bbb0.f511de9d.js"],"c7c99b5b":["/c7c99b5b.6650e86d.js"],"cc3ff470":["/cc3ff470.790ab7c8.js"],"ccc49370":["/ccc49370.f3eec37a.js"],"ccff80ec":["/ccff80ec.1a67cee2.js"],"cd763dc2":["/cd763dc2.6d7aecc8.js"],"cf002786":["/cf002786.56241037.js"],"d0467b3a":["/d0467b3a.c885eabe.js"],"d0761fa2":["/d0761fa2.36c9bb27.js"],"d2bdf9a5":["/d2bdf9a5.557f7ca1.js"],"d5b79311":["/d5b79311.69605e65.js"],"d698a7b9":["/d698a7b9.03b26731.js"],"d745b465":["/d745b465.5a58cd3b.js"],"d8cea81a":["/d8cea81a.1eeae8a0.js"],"dee7b058":["/dee7b058.cf30cf1b.js"],"df15bfc7":["/df15bfc7.ba793ccb.js"],"df776a46":["/df776a46.66554c14.js"],"e4a74b3c":["/e4a74b3c.4f107024.js"],"e7c86eec":["/e7c86eec.3686c30b.js"],"e9373281":["/e9373281.c23d36c2.js"],"ec011d04":["/ec011d04.2ad38123.js"],"ec5548ad":["/ec5548ad.0214ac9d.js"],"f1a1d03d":["/f1a1d03d.e546a795.js"],"f2ce8607":["/f2ce8607.9a0e2940.js"],"f490fcb0":["/f490fcb0.e95d4552.js"],"f831073e":["/f831073e.72125dee.js"],"fb6ea545":["/fb6ea545.ba7adfbc.js"],"fe3d113b":["/fe3d113b.eba6e3e9.js"]};/*]]>*/</script>

<title data-react-helmet="true">Transactions and Concurrency</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" property="og:title" content="MikroORM Â· TypeScript ORM for Node.js based on Data Mapper, Unit of Work and Identity Map patterns."/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="description" content="## Transaction Demarcation"/><meta data-react-helmet="true" property="og:description" content="## Transaction Demarcation"/><meta data-react-helmet="true" property="og:url" content="https://mikro-orm.io/docs/transactions"/>

<link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"/>


<link rel="stylesheet" type="text/css" href="/styles.b07017b5.css" />

</head>
<body >
<script type="text/javascript">(function() {
  function setDataThemeAttribute(theme) {
    document.querySelector('html').setAttribute('data-theme', theme);
  }
  
  var preferDarkQuery = '(prefers-color-scheme: dark)';
  var mql = window.matchMedia(preferDarkQuery);
  var supportsColorSchemeQuery = mql.media === preferDarkQuery;
  var localStorageTheme = null;
  try {
    localStorageTheme = localStorage.getItem('theme');
  } catch (err) {}
  var localStorageExists = localStorageTheme !== null;

  if (localStorageExists) {
    setDataThemeAttribute(localStorageTheme);
  } else if (supportsColorSchemeQuery && mql.matches) {
    setDataThemeAttribute('dark');
  }
})();</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="MikroORM"/><strong class=""></strong></a><a class="navbar__item navbar__link" href="/docs/installation">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://join.slack.com/t/mikroorm/shared_invite/enQtNTM1ODYzMzM4MDk3LWM4ZDExMjU5ZDhmNjA2MmM3MWMwZmExNjhhNDdiYTMwNWM0MGY5ZTE3ZjkyZTMzOWExNDgyYmMzNDE1NDI5NjA" title="Chat on Slack">Slack</a><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://github.com/mikro-orm/mikro-orm" title="View on GitHub">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"/></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"/></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="MikroORM"/><strong></strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/installation">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://join.slack.com/t/mikroorm/shared_invite/enQtNTM1ODYzMzM4MDk3LWM4ZDExMjU5ZDhmNjA2MmM3MWMwZmExNjhhNDdiYTMwNWM0MGY5ZTE3ZjkyZTMzOWExNDgyYmMzNDE1NDI5NjA" title="Chat on Slack">Slack</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://github.com/mikro-orm/mikro-orm" title="View on GitHub">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="menu menu--responsive"><button aria-label="Open Menu" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Overview</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/installation">Installation &amp; Usage</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/defining-entities">Defining Entities</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/relationships">Modeling Entity Relationships</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/entity-manager">Entity Manager</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/repositories">Entity Repository</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Fundamentals</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/identity-map">Identity Map and Request Context</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/entity-references">Entity References and Reference&lt;T&gt; Wrapper</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/entity-constructors">Using Entity Constructors</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/collections">Collections</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/unit-of-work">Unit of Work</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/docs/transactions">Transactions and Concurrency</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/cascading">Cascading</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/deployment">Deployment</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/decorators">Decorators Reference</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Advanced Features</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/nested-populate">Smart Nested Populate</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/query-conditions">Smart Query Conditions</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/query-builder">Using Query Builder</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/serializing">Serializing</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/entity-helper">Updating Entity Values</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/property-validation">Property Validation</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/lifecycle-hooks">Lifecycle Hooks</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/naming-strategy">Naming Strategy</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/metadata-cache">Metadata Cache</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/debugging">Debugging</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/schema-generator">Schema Generator</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/entity-generator">Entity Generator</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/migrations">Migrations</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/read-connections">Read Replica Connections</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/configuration">Advanced Configuration</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Usage with Different Drivers</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/usage-with-sql">Usage with SQL Drivers</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/usage-with-mongo">Usage with MongoDB</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Recipes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/usage-with-nestjs">Usage with NestJS</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/usage-with-js">Usage with Vanilla JS</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/custom-driver">Creating Custom Driver</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/multiple-schemas">Using Multiple Schemas</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Example Integrations</a><ul class="menu__list"><li class="menu__list-item"><a activeClassName="menu__link--active" class="menu__link" to="https://github.com/mikro-orm/express-ts-example-app" href="https://github.com/mikro-orm/express-ts-example-app">Express + MongoDB + TypeScript</a></li><li class="menu__list-item"><a activeClassName="menu__link--active" class="menu__link" to="https://github.com/mikro-orm/nestjs-example-app" href="https://github.com/mikro-orm/nestjs-example-app">NestJS + MySQL + TypeScript</a></li><li class="menu__list-item"><a activeClassName="menu__link--active" class="menu__link" to="https://github.com/mikro-orm/nestjs-realworld-example-app" href="https://github.com/mikro-orm/nestjs-realworld-example-app">RealWorld example app (Nest + MySQL)</a></li><li class="menu__list-item"><a activeClassName="menu__link--active" class="menu__link" to="https://github.com/mikro-orm/express-js-example-app" href="https://github.com/mikro-orm/express-js-example-app">Express + MongoDB + JavaScript</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="padding-vert--lg"><div class="container"><div class="row"><div class="col"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">Transactions and Concurrency</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="transaction-demarcation"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#transaction-demarcation" title="Direct link to heading">#</a>Transaction Demarcation</h2><p>Transaction demarcation is the task of defining your transaction boundaries. Proper
transaction demarcation is very important because if not done properly it can negatively
affect the performance of your application. Many databases and database abstraction
layers by default operate in auto-commit mode, which means that every single SQL statement
is wrapped in a small transaction. Without any explicit transaction demarcation from your
side, this quickly results in poor performance because transactions are not cheap. </p><p>For the most part, MikroORM already takes care of proper transaction demarcation for you:
All the write operations (INSERT/UPDATE/DELETE) are queued until <code>em.flush()</code>
is invoked which wraps all of these changes in a single transaction.</p><p>However, MikroORM also allows (and encourages) you to take over and control transaction
demarcation yourself.</p><p>These are two ways to deal with transactions when using the MikroORM and are now described
in more detail.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="approach-1-implicitly"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#approach-1-implicitly" title="Direct link to heading">#</a>Approach 1: Implicitly</h3><p>The first approach is to use the implicit transaction handling provided by the MikroORM
<code>EntityManager</code>. Given the following code snippet, without any explicit transaction
demarcation:</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-typescript codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> user </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">User</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token spread operator" style="color:rgb(137, 221, 255)">...</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;George&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> orm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">persistAndFlush</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>Since we do not do any custom transaction demarcation in the above code, <code>em.flush()</code>
will begin and commit/rollback a transaction. This behavior is made possible by the
aggregation of the DML operations by the MikroORM and is sufficient if all the data
manipulation that is part of a unit of work happens through the domain model and thus
the ORM.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="approach-2-explicitly"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#approach-2-explicitly" title="Direct link to heading">#</a>Approach 2: Explicitly</h3><p>The explicit alternative is to use the transactions API directly to control the boundaries.
The code then looks like this:</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-typescript codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> orm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">transactional</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">_em</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//... do some work</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> user </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">User</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token spread operator" style="color:rgb(137, 221, 255)">...</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;George&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  _em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">persistLater</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>Explicit transaction demarcation is required when you want to include custom DBAL operations
in a unit of work or when you want to make use of some methods of the EntityManager API
that require an active transaction. Such methods will throw a <code>ValidationError</code> to inform
you of that requirement.</p><p><code>em.transactional(cb)</code> will flush the inner <code>EntityManager</code> prior to transaction commit.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="exception-handling"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#exception-handling" title="Direct link to heading">#</a>Exception Handling</h3><p>When using implicit transaction demarcation and an exception occurs during
<code>em.flush()</code>, the transaction is automatically rolled back.</p><p>When using explicit transaction demarcation and an exception occurs, the transaction should
be rolled back immediately as demonstrated in the example above. This can be handled elegantly
by the control abstractions shown earlier. Note that when catching Exception you should
generally re-throw the exception. If you intend to recover from some exceptions, catch them
explicitly in earlier catch blocks (but do not forget to rollback the transaction). All
other best practices of exception handling apply similarly (i.e. either log or re-throw,
not both, etc.).</p><p>As a result of this procedure, all previously managed or removed instances of the <code>EntityManager</code>
become detached. The state of the detached objects will be the state at the point at which the
transaction was rolled back. The state of the objects is in no way rolled back and thus the
objects are now out of sync with the database. The application can continue to use the detached
objects, knowing that their state is potentially no longer accurate.</p><p>If you intend to start another unit of work after an exception has occurred you should do
that with a new <code>EntityManager</code>. Simply use <code>em.fork()</code> to obtain fresh copy
with cleared identity map. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="locking-support"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#locking-support" title="Direct link to heading">#</a>Locking Support</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="why-we-need-concurrency-control"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#why-we-need-concurrency-control" title="Direct link to heading">#</a>Why we need concurrency control?</h3><p>If transactions are executed serially (one at a time), no transaction concurrency exists.
However, if concurrent transactions with interleaving operations are allowed, you may easily
run into one of those problems:</p><ol><li>The lost update problem</li><li>The dirty read problem</li><li>The incorrect summary problem</li></ol><p>To mitigate those problems, MikroORM offers support for Pessimistic and Optimistic locking
strategies natively. This allows you to take very fine-grained control over what kind of
locking is required for your entities in your application.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="optimistic-locking"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#optimistic-locking" title="Direct link to heading">#</a>Optimistic Locking</h3><p>Database transactions are fine for concurrency control during a single request. However, a
database transaction should not span across requests, the so-called &quot;user think time&quot;. Therefore
a long-running &quot;business transaction&quot; that spans multiple requests needs to involve several
database transactions. Thus, database transactions alone can no longer control concurrency
during such a long-running business transaction. Concurrency control becomes the partial
responsibility of the application itself.</p><p>MikroORM has integrated support for automatic optimistic locking via a version field. In
this approach any entity that should be protected against concurrent modifications during
long-running business transactions gets a version field that is either a simple number
(mapping type: integer) or a timestamp (mapping type: datetime). When changes to such an
entity are persisted at the end of a long-running conversation the version of the entity
is compared to the version in the database and if they don&#x27;t match, a <code>ValidationError</code>
is thrown, indicating that the entity has been modified by someone else already.</p><p>You designate a version field in an entity as follows. In this example we&#x27;ll use an integer.</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-typescript codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">User</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  @</span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">Property</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  version</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>Alternatively a datetime type can be used (which maps to a SQL timestamp or datetime):</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-typescript codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">User</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  @</span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">Property</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  version</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(255, 203, 107)">Date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>Version numbers (not timestamps) should however be preferred as they can not potentially
conflict in a highly concurrent environment, unlike timestamps where this is a possibility,
depending on the resolution of the timestamp on the particular database platform.</p><p>When a version conflict is encountered during <code>em.flush()</code>, a <code>ValidationError</code>
is thrown and the active transaction rolled back (or marked for rollback). This exception
can be caught and handled. Potential responses to a <code>ValidationError</code> are to present the
conflict to the user or to refresh or reload objects in a new transaction and then retrying
the transaction.</p><p>The time between showing an update form and actually modifying the entity can in the worst
scenario be as long as your applications session timeout. If changes happen to the entity
in that time frame you want to know directly when retrieving the entity that you will hit
an optimistic locking exception:</p><p>You can always verify the version of an entity during a request either when calling
<code>em.findOne()</code>:</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-typescript codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> theEntityId </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> expectedVersion </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">184</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> entity </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> orm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">findOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">User</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> theEntityId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> lockMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token maybe-class-name">LockMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token constant" style="color:rgb(130, 170, 255)">OPTIMISTIC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> lockVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> expectedVersion </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// do the work</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> orm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">flush</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token console class-name" style="color:rgb(255, 203, 107)">console</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Sorry, but someone else has already changed this entity. Please apply the changes again!&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>Or you can use <code>em.lock()</code> to find out:</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-typescript codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> theEntityId </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> expectedVersion </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">184</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> entity </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> orm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">findOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">User</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> theEntityId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// assert version</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> orm</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">entity</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token maybe-class-name">LockMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token constant" style="color:rgb(130, 170, 255)">OPTIMISTIC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> expectedVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token console class-name" style="color:rgb(255, 203, 107)">console</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Sorry, but someone else has already changed this entity. Please apply the changes again!&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="important-implementation-notes"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#important-implementation-notes" title="Direct link to heading">#</a>Important Implementation Notes</h4><p>You can easily get the optimistic locking workflow wrong if you compare the wrong versions.
Say you have Alice and Bob editing a hypothetical blog post:</p><ul><li>Alice reads the headline of the blog post being &quot;Foo&quot;, at optimistic lock version 1 (GET Request)</li><li>Bob reads the headline of the blog post being &quot;Foo&quot;, at optimistic lock version 1 (GET Request)</li><li>Bob updates the headline to &quot;Bar&quot;, upgrading the optimistic lock version to 2 (POST Request of a Form)</li><li>Alice updates the headline to &quot;Baz&quot;, ... (POST Request of a Form)</li></ul><p>Now at the last stage of this scenario the blog post has to be read again from the database
before Alice&#x27;s headline can be applied. At this point you will want to check if the blog
post is still at version 1 (which it is not in this scenario).</p><p>Using optimistic locking correctly, you <strong>have</strong> to add the version as an additional hidden
field (or into the session for more safety). Otherwise you cannot verify the version is still
the one being originally read from the database when Alice performed her GET request for the
blog post. If this happens you might see lost updates you wanted to prevent with Optimistic
Locking.</p><p>See the example code (frontend):</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-typescript codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> res </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">fetch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;api.example.com/book/123&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> book </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> res</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">json</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token console class-name" style="color:rgb(255, 203, 107)">console</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">book</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// prints the current version</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// user does some changes and calls the PUT handler</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> changes </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> title</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;new title&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">fetch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;api.example.com/book/123&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  method</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;PUT&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  body</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token spread operator" style="color:rgb(137, 221, 255)">...</span><span class="token plain">changes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> book</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>And the corresponding API endpoints:</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-typescript codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// GET /book/:id</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">findOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> book </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">findOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">Book</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain">req</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  res</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">json</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">book</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// PUT /book/:id</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">update</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> book </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">findOne</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">Book</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain">req</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> lockMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token maybe-class-name">LockMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token constant" style="color:rgb(130, 170, 255)">OPTIMISTIC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> lockVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> req</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">body</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">version</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">wrap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">book</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">assign</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">req</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">body</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">em</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">flush</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  res</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">json</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">book</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>Your frontend app loads an entity from API, the response includes the version property.
User makes some changes and fires PUT request back to the API, with version field included
in the payload. The PUT handler of the API then reads the version and passes it to the
<code>em.findOne()</code> call.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="pessimistic-locking"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#pessimistic-locking" title="Direct link to heading">#</a>Pessimistic Locking</h3><p>MikroORM supports Pessimistic Locking at the database level. No attempt is being made to implement
pessimistic locking inside MikroORM, rather vendor-specific and ANSI-SQL commands are used to
acquire row-level locks. Every Entity can be part of a pessimistic lock, there is no special
metadata required to use this feature.</p><p>However for Pessimistic Locking to work you have to disable the Auto-Commit Mode of your Database
and start a transaction around your pessimistic lock use-case using the &quot;Approach 2: Explicit
Transaction Demarcation&quot; described above. MikroORM will throw an Exception if you attempt to
acquire an pessimistic lock and no transaction is running.</p><p>MikroORM currently supports two pessimistic lock modes:</p><ul><li>Pessimistic Write (<code>LockMode.PESSIMISTIC_WRITE</code>), locks the underlying database rows for concurrent Read and Write Operations.</li><li>Pessimistic Read (<code>LockMode.PESSIMISTIC_READ</code>), locks other concurrent requests that attempt to update or lock rows in write mode.</li></ul><p>You can use pessimistic locks in three different scenarios:</p><ol><li>Using <code>em.findOne(className, id, { lockMode: LockMode.PESSIMISTIC_WRITE })</code> or <code>em.findOne(className, id, { lockMode: LockMode.PESSIMISTIC_READ })</code></li><li>Using <code>em.lock(entity, LockMode.PESSIMISTIC_WRITE)</code> or <code>em.lock(entity, LockMode.PESSIMISTIC_READ)</code></li><li>Using <code>QueryBuilder.setLockMode(LockMode.PESSIMISTIC_WRITE)</code> or <code>QueryBuilder.setLockMode(LockMode.PESSIMISTIC_READ)</code></li></ol><blockquote><p>This part of documentation is highly inspired by <a href="https://www.doctrine-project.org/projects/doctrine-orm/en/latest/reference/transactions-and-concurrency.html">doctrine internals docs</a>
as the behaviour here is pretty much the same.</p></blockquote></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/mikro-orm/mikro-orm/edit/master/docs/docs/transactions.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/unit-of-work"><h5 class="pagination-nav__link--sublabel">Previous</h5><h4 class="pagination-nav__link--label">Â« <!-- -->Unit of Work and Transactions</h4></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/cascading"><h5 class="pagination-nav__link--sublabel">Next</h5><h4 class="pagination-nav__link--label">Cascading persist, merge and remove<!-- --> Â»</h4></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#transaction-demarcation" class="contents__link">Transaction Demarcation</a><ul class=""><li><a href="#approach-1-implicitly" class="contents__link">Approach 1: Implicitly</a></li><li><a href="#approach-2-explicitly" class="contents__link">Approach 2: Explicitly</a></li><li><a href="#exception-handling" class="contents__link">Exception Handling</a></li></ul></li><li><a href="#locking-support" class="contents__link">Locking Support</a><ul class=""><li><a href="#why-we-need-concurrency-control" class="contents__link">Why we need concurrency control?</a></li><li><a href="#optimistic-locking" class="contents__link">Optimistic Locking</a></li><li><a href="#pessimistic-locking" class="contents__link">Pessimistic Locking</a></li></ul></li></ul></div></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/installation">Installation &amp; Usage</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://github.com/mikro-orm/mikro-orm#-quick-start">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/upgrading-v2-to-v3">Migration from v2 to v3</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/v2/installation">Version 2.7 docs</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://join.slack.com/t/mikroorm/shared_invite/enQtNTM1ODYzMzM4MDk3LWM4ZDExMjU5ZDhmNjA2MmM3MWMwZmExNjhhNDdiYTMwNWM0MGY5ZTE3ZjkyZTMzOWExNDgyYmMzNDE1NDI5NjA">Slack</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/questions/ask?tags=mikro-orm">Stack Overflow</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" to="https://twitter.com/B4nan" href="https://twitter.com/B4nan">Twitter</a></li><iframe src="https://ghbtns.com/github-btn.html?user=mikro-orm&amp;repo=mikro-orm&amp;type=star&amp;count=true" style="margin-top:10px" frameBorder="0" scrolling="0" width="100" height="30" title="GitHub Stars"></iframe></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><img class="footer__logo" alt="MikroORM" src="/img/logo-header.svg"/></div>Copyright Â© 2019 Martin AdÃ¡mek. Built with Docusaurus. <!-- -->Icons made by <a href="https://www.flaticon.com/authors/surang" title="surang">surang</a> and <a href="https://www.flaticon.com/authors/skyclick" title="Skyclick">Skyclick</a>.</div></div></footer>
</div>

<script type="text/javascript" src="/styles.991f00a3.js"></script>

<script type="text/javascript" src="/runtime~main.1b9c21a3.js"></script>

<script type="text/javascript" src="/main.4967bba5.js"></script>

<script type="text/javascript" src="/1.e455894f.js"></script>

<script type="text/javascript" src="/1be78505.98bf3285.js"></script>

<script type="text/javascript" src="/9c9e4252.1e481b0c.js"></script>

<script type="text/javascript" src="/17896441.603aee67.js"></script>

<script type="text/javascript" src="/2ecdc8fb.b7f7adb9.js"></script>

<script type="text/javascript" src="/5e41dd96.8ceeeb08.js"></script>


</body>
</html>